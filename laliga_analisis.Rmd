---
title: "datos_liga"
author: "Enrique"
date: "2022-10-22"
output: html_document
---

```{r include=FALSE}
# Librerías
library(dplyr)
library(readr)
library(ggplot2)
library(cowplot)
```

## ANÁLISIS EXPLORATORIO INICIAL

```{r include=FALSE}
laliga <- read_csv("combined_data_laliga.csv")
```

```{r}
# primeros estadisticos de clase
str(laliga)
```

```{r}
summary(laliga) #medias y medianas son bastante similares, asi que se pueden analizar como normales
```

El dataframe contiene todos los partidos de la liga española de 7 temporadas (de 2014 a 2020).\

-   2660 observaciones (partidos)
-   41 variables

**Home Team**: Equipo local\
**Away Team**: Equipo visitante\
**Score**: Resultado\
**Half Time Score**: Resultado al descanso\
**Match Excitement**: Emoción del partido (subjetiva)\
**Home Team Rating**: Nota del local\
**Away Team Rating**: Nota del visitante\
**Home Team Possession**: Posesión local\
**Away Team Possession**: Posesión visitante\
**Home Team off Target Shots**: Tiros fuera local\
**Home Team on Target Shots**: Tiros a puerta local\
**Home Team Total Shots**: Total tiros local\
**Home Team Blocked Shots**: Tiros bloqueados local\
**Home Team Corners**: Corners local\
**Home Team Throw Ins**: Centros local\
**Home Team Pass Success**: Pases exitosos local\
**Home Team Aerials Won**: Balones aereos ganados local\
**Home Team Clearences**: Despejes local\
**Home Team Fouls**: Faltas local\
**Home Team Yellow Cards**: Amarillas local\
**Home Team Second Yellow Cards**: Segundas amarillas local\
**Home Team Red Cards**: Rojas local\
**Away Team off Target Shots**: Tiros fuera visitante\
**Away Team on Target Shots**: Tiros a puerta visitante\
**Away Team Total Shots**: Total tiros visitante\
**Away Team Blocked Shots**: Tiros bloqueados visitante\
**Away Team Corners**: Corners visitante\
**Away Team Throw Ins**: Centros visitante\
**Away Team Pass Success**: Pases exitosos visitante\
**Away Team Aerials Won**: Balones aereos ganados visitante\
**Away Team Clearences**: Despejes visitante\
**Away Team Fouls**: Faltas visitante\
**Away Team Yellow Cards**: Amarillas visitante\
**Away Team Second Yellow Cards**: Segundas amarillas visitante\
**Away Team Red Cards**: Rojas visitante\
**Home Team Goals Scored**: Goles local\
**Away Team Goals Scored**: Goles visitante\
**Home Team Goals Conceeded**: Goles visitante\
**Away Team Goals Conceeded**: Goles local\
**Year**: Año\


## LIMPIEZA DE DATOS

```{r}
#Limpio los datos de las columnas quitando los espacios y cambiandolos por guiones, puesto que los espacios dan bastantes problemas a la hora de llamar a las variables
names(laliga) <- gsub(" ","_", names(laliga))
```

```{r}
# Limpieza de variables que no nos interesan
laliga$Score <-  NULL
laliga$`Half_Time_Score` <- NULL
laliga$`Match_Excitement` <- NULL
laliga$`Home_Team_Rating` <- NULL
laliga$`Away_Team_Rating` <- NULL
laliga$`Home_Team_Goals_Conceeded` <- NULL
laliga$`Away_Team_Goals_Conceeded` <- NULL
```

```{r}
# Añadimos la columna resultado (tipo quiniela)
laliga <- mutate(laliga, resultado = ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored > 0, "1",
                                          ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored < 0, "2", "x")))

# Añadimos la columna con los goles totales (por partido)
laliga <- mutate(laliga, goles = Home_Team_Goals_Scored+Away_Team_Goals_Scored)
```

```{r}
# Convertimos a categorias
laliga$Home_Team <- as.factor(laliga$Home_Team)
laliga$Away_Team <- as.factor(laliga$Away_Team)
laliga$resultado <- as.factor(laliga$resultado)
```


## DEFINICIÓN DE OBJETIVOS

-   ¿Qué hace que un equipo gane un partido?
-   ¿Qué variables influyen en las victorias?
-   Predecir el ganador de un partido


```{r}
# Dividimos los datos en dos datasets (train y test)
test <- filter(laliga, year==2020)
train <- filter(laliga, year<2020)
#write.csv(test,"test/test_laliga.csv")
#write.csv(train,"train/train_laliga.csv")
```

```{r include=FALSE}
# dataframes separados por resultado
Victorias_casa <- train %>% filter(resultado==1)
Derrotas_casa <- train %>% filter(resultado==2)
Empates <- train %>% filter(resultado=="x")
```

## ANÁLISIS

```{r}
table(train$Home_Team) # de aqui sacamos los equipos que más partidos han jugado (más años en primera division)

#prop.table(table(train$Home_Team))
#table(train$Home_Team, train$Away_Team)
```
10 equipos(Athletic, Atletico, Barcelona, Eibar, Espanyol, Real Madrid, Real Sociedad, Sevilla, Valencia y Villarreal) han estado todas las temporadas en primera.\

```{r}
ggplot(train,aes(x=resultado)) + geom_bar()
# se ve que jugar en casa es un factor importante para ganar (aprox. la mitad de partidos los gana el de casa)
```

```{r}
#Porcentaje de victorias caseras(TRUE)
prop.table(table(train$Home_Team_Goals_Scored > train$Away_Team_Goals_Scored))
```

```{r}
#Porcentaje de empates
prop.table(table(train$Home_Team_Goals_Scored == train$Away_Team_Goals_Scored))
```

```{r}
#Porcentaje de derrotas caseras
prop.table(table(train$Home_Team_Goals_Scored < train$Away_Team_Goals_Scored))
```


```{r}
ggplot(train,aes(resultado ,goles)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'lightgreen') +
  labs(title="Media de goles por partido", x="resultado", y="goles") +
  theme(plot.title=element_text(hjust = 0.5))

# en los partidos con victorias locales hay más goles de media que en los que gana el visitante (y bastante más que en los que hay empate). Por tanto, un partido con más goles es más probable que no acabe en empate.
```

```{r}
ggplot(train,aes(resultado ,Home_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'green') +
  labs(title="media de goles locales por partido", x="resultado", y="goles local") +
  theme(plot.title=element_text(hjust = 0.5))

# Cuando el equipo local gana, mayor es su media de goles. Es decir, a mas goles, mas victorias (obvio pero habia que comprobarlo)
```

```{r}
ggplot(train,aes(resultado ,Away_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'green') +
  labs(title="media de goles visitante por partido", x="resultado", y="goles visitante") +
  theme(plot.title=element_text(hjust = 0.5))

# Cuando el equipo local pierde, mayor es la media de goles del visitante. Es decir, a mas goles encajados, mas derrotas (obvio pero habia que comprobarlo)
```

```{r}
#Media de goles por partido
sum(train$Home_Team_Goals_Scored, train$Away_Team_Goals_Scored)/nrow(train)
```

```{r}
#Media de goles por partido con victoria local
sum(Victorias_casa$Home_Team_Goals_Scored,Victorias_casa$Away_Team_Goals_Scored)/nrow(Victorias_casa)
```

```{r}
#Media de goles por partido con victoria visitante
sum(Derrotas_casa$Home_Team_Goals_Scored,Derrotas_casa$Away_Team_Goals_Scored)/nrow(Derrotas_casa)
```

```{r}
#Media de goles por partido con empate
sum(Empates$Home_Team_Goals_Scored,Empates$Away_Team_Goals_Scored)/nrow(Empates)
```


```{r}
ggplot(train,aes(resultado ,Home_Team_Total_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros local por partido", x="resultado", y="tiros local") +
  theme(plot.title=element_text(hjust = 0.5))

# El número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)
```

```{r}
ggplot(train,aes(resultado ,Home_Team_On_Target_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros a puerta local por partido", x="resultado", y="tiros a puerta local") +
  theme(plot.title=element_text(hjust = 0.5))

# Sin embargo el número de tiros a puerta si influye (cuantos más tiros a puerta, más cerca de la victoria)
```

```{r}
ggplot(train,aes(resultado ,`Home_Team_Possession_%`)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'orange') +
  labs(title="Gráfica Pep", x="resultado", y="posesion local") +
  theme(plot.title=element_text(hjust = 0.5))

# No parece influir mucho la posesión
```

```{r}
ggplot(train,aes(resultado ,`Away_Team_Possession_%`)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'orange') +
  labs(title="Gráfica Pep", x="resultado", y="posesion visitante") +
  theme(plot.title=element_text(hjust = 0.5))

# El equipo local suele tener más posesion (>50%) independientemente del resultado
```

```{r}
#Porcentaje medio de posesión por equipo en casa
tapply(train$`Home_Team_Possession_%`,train$`Home_Team`,mean)
```

```{r}
#Porcentaje medio de posesión por equipo fuera de casa
tapply(train$`Away_Team_Possession_%`,train$`Away_Team`,mean)
```

```{r}
summary(Empates$`Home_Team_Possession_%`)
summary(Victorias_casa$`Home_Team_Possession_%`)
summary(Derrotas_casa$`Home_Team_Possession_%`)
#Con estos datos tan similares sacamos en conclusión que la posesión no ha influido mucho en las victorias(pobre Pep)
```


```{r}
ggplot(train,aes(Home_Team ,Home_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'red') +
  labs(title="media de goles de cada equipo como local", x="equipos", y="goles por partido") +
  theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))

# media de goles por partido de cada equipo en su casa
```

```{r}
aggregate(Home_Team_Goals_Scored ~ Home_Team, data = train, FUN = mean) -> goles_home_team
goles_home_team
```


```{r}
ggplot(train,aes(Away_Team ,Away_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'red') +
  labs(title="media de goles de cada equipo como visitante", x="equipos", y="goles por partido") +
  theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))

# Los equipos que más goles meten por partido, son los que más temporadas han estado en primera
```

```{r}
aggregate(Away_Team_Goals_Scored ~ Away_Team, data = train, FUN = mean) -> goles_Away_team
goles_Away_team
```


```{r}
# Correlación de algunas variables
pairs(train %>%
        select(Home_Team_Goals_Scored, Home_Team_On_Target_Shots, Home_Team_Total_Shots, `Home_Team_Possession_%`, `Home_Team_Pass_Success_%`, Home_Team_Corners, Home_Team_Throw_Ins, Home_Team_Fouls, Home_Team_Aerials_Won), pch = 21, bg = "black", col = "red")
```

```{r}
hist(train$Home_Team_Goals_Scored,breaks=15, main = "Histograma de goles en casa", 
     xlab = "goles")
```

```{r}
hist(train$Away_Team_Goals_Scored,breaks=15, main = "Histograma de goles fuera", 
     xlab = "goles")
# Se marcan más goles en casa que fuera
```

```{r}
lm_fit <- lm(Home_Team_Goals_Scored~.-Home_Team, data=train)
summary(lm_fit)

#regfit_fwd <- leaps::regsubsets(Home_Team_Goals_Scored~., train, method="forward")
#for (metric in c("r2", "adjr2", "Cp", "bic")){plot(regfit_fwd, scale=metric)}
```

Variables más influyentes en los goles marcados: Centros, despejes, tarjetas rojas,\


```{r}
prop.table(table(Victorias_casa$Home_Team_Total_Shots > Victorias_casa$Away_Team_Total_Shots))
#En un 30% de las victorias de casa el equipo de casa tiró menos tiros que el de fuera
```

```{r}
prop.table(table(Victorias_casa$Home_Team_Blocked_Shots > Victorias_casa$Away_Team_Blocked_Shots))
#Los tiros bloqueados no influyen mucho en el resultado del partido
```

```{r}
prop.table(table(Derrotas_casa$Home_Team_Blocked_Shots > Derrotas_casa$Away_Team_Blocked_Shots))
#En las derrotas si vemos que el 43% de las veces bloquearon menos 
```

## CONCLUSIONES
Hay muchas variables que no afectan al resultado de un partido.\
Los equipos locales ganan más.\

Hay dos equipos que sobresalen (Madrid y Barsa)\
Hay un grupo de equipos "buenos" (nunca han descendido, meten más goles...)

De cara al futuro:\
Cuanto se parecen dos partidos?\
Clusterizar equipos en buenos, medios y malos.\
Calcular los puntos que suma cada equipo por partido en función de ser local o visitante, del "nivel" del rival, etc.\
Predecir el número de goles que va a marcar cada equipo en un partido, en vez de victoria/derrota/empate.


