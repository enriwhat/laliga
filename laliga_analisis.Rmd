---
title: "datos_liga"
author: "Enrique, Miguel, Sergio"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    theme: flatly
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	include = TRUE,
	warning = TRUE,
	message = FALSE,
	fig.align = "center",
	fig.height=4,
	fig.width=15,
	out.width = "90%"
)
```

# INTRODUCCIÓN Y DEFINICIÓN DE OBJETIVOS

-   ¿Qué hace que un equipo gane un partido?
-   ¿Qué variables influyen en las victorias?
-   Predecir el ganador de un partido

\
```{r}
# Librerías
library(dplyr)
library(tidyr)
library(knitr)
library(readr)
library(ggplot2)
library(cowplot)
library(GGally)
```
\
\
\

# ANÁLISIS EXPLORATORIO INICIAL

```{r}
laliga <- read_csv("combined_data_laliga.csv")
```

```{r}
# primeros estadisticos de clase
str(laliga)
```

```{r}
summary(laliga) #medias y medianas son bastante similares, asi que se pueden analizar como normales
```

El dataframe contiene todos los partidos de la liga española de 7 temporadas (de 2014 a 2020).\

-   2660 observaciones (partidos)
-   41 variables

**Home Team**: Equipo local\
**Away Team**: Equipo visitante\
**Score**: Resultado\
**Half Time Score**: Resultado al descanso\
**Match Excitement**: Emoción del partido (subjetiva)\
**Home Team Rating**: Nota del local (subjetiva)\
**Away Team Rating**: Nota del visitante (subjetiva)\
**Home Team Possession**: Posesión local\
**Away Team Possession**: Posesión visitante\
**Home Team off Target Shots**: Tiros fuera local\
**Home Team on Target Shots**: Tiros a puerta local\
**Home Team Total Shots**: Total tiros local\
**Home Team Blocked Shots**: Tiros bloqueados local\
**Home Team Corners**: Corners local\
**Home Team Throw Ins**: Centros local\
**Home Team Pass Success**: Pases exitosos local\
**Home Team Aerials Won**: Balones aereos ganados local\
**Home Team Clearences**: Despejes local\
**Home Team Fouls**: Faltas local\
**Home Team Yellow Cards**: Amarillas local\
**Home Team Second Yellow Cards**: Segundas amarillas local\
**Home Team Red Cards**: Rojas local\
**Away Team off Target Shots**: Tiros fuera visitante\
**Away Team on Target Shots**: Tiros a puerta visitante\
**Away Team Total Shots**: Total tiros visitante\
**Away Team Blocked Shots**: Tiros bloqueados visitante\
**Away Team Corners**: Corners visitante\
**Away Team Throw Ins**: Centros visitante\
**Away Team Pass Success**: Pases exitosos visitante\
**Away Team Aerials Won**: Balones aereos ganados visitante\
**Away Team Clearences**: Despejes visitante\
**Away Team Fouls**: Faltas visitante\
**Away Team Yellow Cards**: Amarillas visitante\
**Away Team Second Yellow Cards**: Segundas amarillas visitante\
**Away Team Red Cards**: Rojas visitante\
**Home Team Goals Scored**: Goles local\
**Away Team Goals Scored**: Goles visitante\
**Home Team Goals Conceeded**: Goles visitante\
**Away Team Goals Conceeded**: Goles local\
**Year**: Año\
\
\
\

# LIMPIEZA DE DATOS

```{r}
#Limpio los datos de las columnas quitando los espacios y cambiandolos por guiones, puesto que los espacios dan bastantes problemas a la hora de llamar a las variables
names(laliga) <- gsub(" ","_", names(laliga))
```

```{r}
# Limpieza de variables que no nos interesan
laliga$Score <-  NULL
laliga$`Half_Time_Score` <- NULL
laliga$`Match_Excitement` <- NULL
laliga$`Home_Team_Rating` <- NULL
laliga$`Away_Team_Rating` <- NULL
laliga$`Home_Team_Goals_Conceeded` <- NULL
laliga$`Away_Team_Goals_Conceeded` <- NULL
```

```{r}
laliga <- mutate(laliga, score = ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored > 0, "1",
                                          ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored < 0, "2", "x")))

laliga <- mutate(laliga, goals = Home_Team_Goals_Scored + Away_Team_Goals_Scored)

laliga <- mutate(laliga, home_points = case_when(score == 1 ~ 3,
                                                 score == "x" ~ 1,
                                                 score == 2 ~ 0))
laliga <- mutate(laliga, away_points = case_when(score == 1 ~ 0,
                                                 score == "x" ~ 1,
                                                 score == 2 ~ 3))

laliga <- mutate(laliga, jornada = ceiling(row_number() / 10)) %>%
        mutate(jornada = (jornada - 1) %% 38 + 1)
```

```{r}
laliga <- mutate(laliga, total_off_target_shots = Home_Team_Off_Target_Shots + Away_Team_Off_Target_Shots)
laliga <- mutate(laliga, total_on_target_shots = Home_Team_On_Target_Shots + Away_Team_On_Target_Shots)
laliga <- mutate(laliga, total_shots = Home_Team_Total_Shots + Away_Team_Total_Shots)
laliga <- mutate(laliga, total_blocked_shots = Home_Team_Blocked_Shots + Away_Team_Blocked_Shots)
laliga <- mutate(laliga, total_corners = Home_Team_Corners + Away_Team_Corners)
laliga <- mutate(laliga, total_throw_ins = Home_Team_Throw_Ins + Away_Team_Throw_Ins)
laliga <- mutate(laliga, total_pass_success = `Home_Team_Pass_Success_%` + `Away_Team_Pass_Success_%`)
laliga <- mutate(laliga, total_aerials_won = Home_Team_Aerials_Won + Away_Team_Aerials_Won)
laliga <- mutate(laliga, total_clearances = Home_Team_Clearances + Away_Team_Clearances)
laliga <- mutate(laliga, total_fouls = Home_Team_Fouls + Away_Team_Fouls)
laliga <- mutate(laliga, total_yellow_cards = Home_Team_Yellow_Cards + Away_Team_Yellow_Cards)
laliga <- mutate(laliga, total_second_yellow_cards = Home_Team_Second_Yellow_Cards + Away_Team_Second_Yellow_Cards)
laliga <- mutate(laliga, total_red_cards = Home_Team_Red_Cards + Away_Team_Red_Cards)
```

```{r}
# Convertimos a categorias
laliga$Home_Team <- as.factor(laliga$Home_Team)
laliga$Away_Team <- as.factor(laliga$Away_Team)
laliga$score <- factor(laliga$score, levels = c("1", "x", "2"))

#laliga$year <- as.factor(laliga$year)
#laliga$jornada <- as.factor(laliga$jornada)
```
\
\
```{r}
# Dividimos los datos en dos datasets (train y test)
test <- filter(laliga, year==2020)
train <- filter(laliga, year<2020)
#write.csv(test,"test/test_laliga.csv")
#write.csv(train,"train/train_laliga.csv")
```

```{r}
# dataframes separados por resultado
Victorias_casa <- train %>% filter(score==1)
Derrotas_casa <- train %>% filter(score==2)
Empates <- train %>% filter(score=="x")
```
\
\
# ANÁLISIS

```{r}
train %>% select(25:35) %>%
  ggpairs(aes(color = score, alpha = .5))
```

## VARIABLES CUALITATIVAS

### RESUMEN NUMERICO

```{r}
# de aqui sacamos los equipos que ha jugado cada equipo (más años en primera division)
as.data.frame(table(train$Home_Team) + table(train$Away_Team)) %>% arrange(desc(Freq))
```

```{r}
#numero y proporcion de victorias, derrotas y empates
table(train$score)
prop.table(table(train$score))*100
```

```{r}
# aqui vemos cuantos partidos han ganado, empatado y perdido cada equipo
with(train, table(Home_Team, score))
with(train, table(Away_Team, score))
```

```{r}
# porcentaje de victorias, derrotas y empates de cada equipo
round(t((prop.table(with(train, table(score, Home_Team)), margin = 2)))*100,2)
round(t((prop.table(with(train, table(score, Away_Team)), margin = 2)))*100,2)

```

### VISUALIZACION

```{r}
ggplot(train, aes(score, fill = score)) +
  geom_bar() +
  scale_fill_manual(values = c("limegreen", "lightblue", "indianred")) +
  labs(x = "Resultado", y = "Nº de resultados", title = "Nº de victorias Local / Visitante / Empate") + theme(plot.title = element_text(hjust = 0.5))
# se ve que jugar en casa es un factor importante para ganar (aprox. la mitad de partidos los gana el de casa)
```

```{r}
ggplot(train, aes(Home_Team)) +
  geom_bar() +
  coord_flip() +
  labs(x = "Resultado", y = "Nº de resultados", title = "Nº de victorias Local / Visitante / Empate")
  
```

```{r}
ggplot(train,aes(score ,goals, fill = score)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean") +
  scale_fill_manual(values = c("limegreen", "lightblue", "indianred")) +
  labs(title="Media de goles por partido", x="resultado", y="goles") +
  theme(plot.title=element_text(hjust = 0.5))

# en los partidos con victorias locales hay más goles de media que en los que gana el visitante (y bastante más que en los que hay empate). Por tanto, un partido con más goles es más probable que no acabe en empate.
```

```{r}
ggplot(train,aes(score ,Home_Team_Goals_Scored, Away_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'green') +
  labs(title="media de goles EQ. LOCAL por partido", x="resultado", y="goles local") +
  theme(plot.title=element_text(hjust = 0.5))

# Cuando el equipo local gana, mayor es su media de goles. Es decir, a mas goles, mas victorias (obvio pero habia que comprobarlo)

#JUNTAR ESTA GRAFICA CON LA ANTERIOR (cada columna coloreada con los goles locales y visitantes)
```

```{r}
ggplot(train,aes(score ,Away_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'green') +
  labs(title="media de goles EQ. VISITANTE por partido", x="resultado", y="goles visitante") +
  theme(plot.title=element_text(hjust = 0.5))

# Cuando el equipo local pierde, mayor es la media de goles del visitante. Es decir, a mas goles encajados, mas derrotas (obvio pero habia que comprobarlo)
```

```{r}
ggplot(train,aes(score , total_shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="Media de disparos por partido", x="resultado", y="disparos") +
  theme(plot.title=element_text(hjust = 0.5))

# en los partidos el numero total de disparos está bastante igualado con independencia de la victoria, derrota o empate.
```

```{r}
ggplot(train,aes(score ,Home_Team_Total_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros EQ. LOCAL por partido", x="resultado", y="tiros local") +
  theme(plot.title=element_text(hjust = 0.5))

# El número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)
```

```{r}
ggplot(train,aes(score ,Home_Team_On_Target_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros a puerta EQ. LOCAL por partido", x="resultado", y="tiros a puerta local") +
  theme(plot.title=element_text(hjust = 0.5))

# Sin embargo el número de tiros a puerta si influye (cuantos más tiros a puerta, más cerca de la victoria)
```


```{r}
ggplot(train,aes(score ,Away_Team_Total_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros EQ. VISITANTE por partido", x="resultado", y="tiros local") +
  theme(plot.title=element_text(hjust = 0.5))

# Igual que para el equipo local, el número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)
```

```{r}
ggplot(train,aes(score ,Away_Team_On_Target_Shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'pink') +
  labs(title="media de tiros a puerta EQ. VISITANTE por partido", x="resultado", y="tiros a puerta local") +
  theme(plot.title=element_text(hjust = 0.5))

# Sin embargo  volvemos a ver que el número de tiros a puerta si influye (cuantos más tiros a puerta, más cerca de la victoria)
```

```{r}
ggplot(train,aes(score ,`Home_Team_Possession_%`)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'orange') +
  labs(title="Gráfica Pep", x="resultado", y="posesion local") +
  theme(plot.title=element_text(hjust = 0.5))

# No parece influir mucho la posesión
```

```{r}
ggplot(train,aes(score ,`Away_Team_Possession_%`)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'orange') +
  labs(title="Gráfica Pep", x="resultado", y="posesion visitante") +
  theme(plot.title=element_text(hjust = 0.5))

# El equipo local suele tener más posesion (>50%) independientemente del resultado
```

```{r}
ggplot(train,aes(score ,total_blocked_shots)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = "grey") +
  labs(title="Media de tiros bloqueados por partido", x="resultado", y="tiros bloqueados") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de disparos bloqueados no parece un factor determinante en la victoria
```

```{r}
ggplot(train,aes(score ,total_aerials_won)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = "brown") +
  labs(title="Media de duelos aereos por partido", x="resultado", y="duelos aereos") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de duelos aereos no parece un factor determinante en la victoria
```

```{r}
ggplot(train,aes(score ,total_corners)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'blue') +
  labs(title="Media de corners por partido", x="resultado", y="corners") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de corners no parece un factor determinante en la victoria se puede observar como con independencia del ganadar el numero de corners está muy repartido
```

```{r}
ggplot(train,aes(score ,total_throw_ins)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'lightblue') +
  labs(title="Media de centros por partido", x="resultado", y="centros") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de centros no parece un factor determinante en la victoria se puede observar como con independencia del ganadar el numero de centros está muy repartido
```

```{r}
ggplot(train,aes(score ,total_clearances)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'lightgreen') +
  labs(title="Media de despejes por partido", x="resultado", y="despejes") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de despejes no parece un factor determinante en la victoria incluso parece que a mayor número de despejes medios el partido parece más probable que acabe en empate
```

```{r}
ggplot(train,aes(score ,total_fouls)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'lightyellow') +
  labs(title="Media de faltas por partido", x="resultado", y="faltas") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de faltas no parece un factor determinante.
```

```{r}
ggplot(train,aes(score ,total_yellow_cards)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'yellow') +
  labs(title="Media de amarillas por partido", x="resultado", y="amarillas") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de tarjetas amarillas no parece un factor determinante.
```

```{r}
ggplot(train,aes(score ,total_red_cards)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'red') +
  labs(title="Media de rojas por partido", x="resultado", y="rojas") +
  theme(plot.title=element_text(hjust = 0.5))

# El numero de tarjetas rojas no parece un factor determinante.
```

10 equipos(Athletic, Atletico, Barcelona, Eibar, Espanyol, Real Madrid, Real Sociedad, Sevilla, Valencia y Villarreal) han estado todas las temporadas en primera.\

## VARIABLES CUANTITATIVAS

### RESUMEN NUMERICO

```{r}
# Posesion
summary(train$`Home_Team_Possession_%`)
summary(train$`Away_Team_Possession_%`)
```

```{r}
# Tiros
summary(train$Home_Team_Off_Target_Shots)
summary(train$Away_Team_Off_Target_Shots)

summary(train$Home_Team_On_Target_Shots)
summary(train$Away_Team_On_Target_Shots)

summary(train$Home_Team_Total_Shots)
summary(train$Away_Team_Total_Shots)
```

```{r}
# Bloqueos
summary(train$Home_Team_Blocked_Shots)
summary(train$Away_Team_Blocked_Shots)
```

```{r}
# Corners
summary(train$Home_Team_Corners)
summary(train$Away_Team_Corners)
```

```{r}
# Centros
summary(train$Home_Team_Throw_Ins)
summary(train$Away_Team_Throw_Ins)
```

```{r}
# Pases
summary(train$`Home_Team_Pass_Success_%`)
summary(train$`Away_Team_Pass_Success_%`)
```

```{r}
# Balones aereos
summary(train$Home_Team_Aerials_Won)
summary(train$Away_Team_Aerials_Won)
```

```{r}
# Despejes
summary(train$Home_Team_Clearances)
summary(train$Away_Team_Clearances)
```

```{r}
# Faltas
summary(train$Home_Team_Fouls)
summary(train$Away_Team_Fouls)
```

```{r}
# Amarillas
summary(train$Home_Team_Yellow_Cards)
summary(train$Away_Team_Yellow_Cards)
```

```{r}
# Segundas amarillas
summary(train$Home_Team_Second_Yellow_Cards)
summary(train$Away_Team_Second_Yellow_Cards)
```

```{r}
# Rojas
summary(train$Home_Team_Red_Cards)
summary(train$Away_Team_Red_Cards)
```

```{r}
# Goles
summary(train$goals)
summary(train$goals)
```

### VISUALIZACION


```{r}
ggplot(train, aes(x = goals, fill = score)) + 
  geom_dotplot(binwidth = 0.1)
```

```{r}
ggplot(train, aes(x = Home_Team_Goals_Scored)) +
  geom_histogram(fill="white", colour="black") +
  ggtitle('Goles')

ggplot(train, aes(x = Away_Team_Goals_Scored)) +
  geom_histogram(fill="white", colour="black") +
  ggtitle('Goles')
```


```{r}
ggplot(train, aes(x = Home_Team_Clearances)) +
  geom_histogram(fill="white", colour="black")

ggplot(train, aes(x = Home_Team_Fouls)) +
  geom_histogram(fill="white", colour="black") 
```

```{r}
ggplot(train, aes(Home_Team_Goals_Scored)) +
  geom_boxplot()

ggplot(train, aes(Away_Team_Goals_Scored)) +
  geom_boxplot()
```


```{r}
goles_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_goles = sum(goals)))
tiros_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_tiros = sum(total_shots)))
tiros_block_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_tiros_bloqueados = sum(total_blocked_shots)))
corners_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_corners = sum(total_corners)))
centros_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_throw_ins = sum(total_throw_ins)))
d_aer_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_d_aer = sum(total_aerials_won)))
t_despj_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_clearances = sum(total_clearances)))
faltas_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_fouls = sum(total_fouls)))
amarll_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_yellow_cards = sum(total_yellow_cards)))
rojas_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_red_cards = sum(total_red_cards)))
```

```{r}

ggplot(goles_year_jorn,  aes(x = jornada, y = total_goles)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de goles", title = "Nº de goles por jornada / Año") + theme(plot.title = element_text(hjust = 0.5)) + xlim(1,38)

ggplot(tiros_year_jorn,  aes(x = jornada, y = total_tiros)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de disparos", title = "Nº de disparos por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(tiros_block_year_jorn,  aes(x = jornada, y = total_tiros_bloqueados)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de disparos_bloqueados", title = "Nº de disparos bloqueados por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(corners_year_jorn,  aes(x = jornada, y = total_corners)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de corners", title = "Nº de corners por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(centros_year_jorn,  aes(x = jornada, y = total_throw_ins)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de centros", title = "Nº de centros por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(t_despj_year_jorn,  aes(x = jornada, y = total_clearances)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de despejes", title = "Nº de despejes por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(faltas_year_jorn,  aes(x = jornada, y = total_fouls)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de faltas", title = "Nº de faltas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(amarll_year_jorn,  aes(x = jornada, y = total_yellow_cards)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de tarj. Amarillas", title = "Nº de tarj. Amarillas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(rojas_year_jorn,  aes(x = jornada, y = total_red_cards)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de tarj. Rojas", title = "Nº de tarj. Rojas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))
```

## MULTIVARIANTE

```{r}
#Media de goles por partido con victoria local
sum(Victorias_casa$Home_Team_Goals_Scored,Victorias_casa$Away_Team_Goals_Scored)/nrow(Victorias_casa)
```

```{r}
#Media de goles por partido con victoria visitante
sum(Derrotas_casa$Home_Team_Goals_Scored,Derrotas_casa$Away_Team_Goals_Scored)/nrow(Derrotas_casa)
```

```{r}
#Media de goles por partido con empate
sum(Empates$Home_Team_Goals_Scored,Empates$Away_Team_Goals_Scored)/nrow(Empates)
```

```{r}
#Puntos promedio por partido por equipo
puntos_promedio_casa <- aggregate((home_points) ~ Home_Team, data = train, mean)

puntos_promedio_fuera <- aggregate(away_points ~ Away_Team, data = train, mean)

puntos_promedio <- data.frame(puntos_promedio_casa$Home_Team, (puntos_promedio_casa$`(home_points)` + puntos_promedio_fuera$away_points)/2)
names(puntos_promedio) <- c("Equipo", "Puntos_por_partido")
puntos_promedio
```

```{r}
#Esta seria la clasificacion con la media de puntos por partido por equipo
clasificacion_media <- arrange(puntos_promedio,desc(Puntos_por_partido))
clasificacion_media
```
\
\
```{r}
aggregate(Home_Team_Goals_Scored ~ Home_Team, data = train, FUN = mean) -> goles_home_team
goles_home_team

aggregate(Away_Team_Goals_Scored ~ Away_Team, data = train, FUN = mean) -> goles_Away_team
goles_Away_team

goles_por_equipo <- data.frame(goles_home_team$Home_Team,(goles_Away_team$Away_Team_Goals_Scored + goles_home_team$Home_Team_Goals_Scored)/2)
names(goles_por_equipo) <- c("equipo", "goals")
goles_por_equipo
```
\
\
```{r}
#No he sido capaz de poner encima una grafica de densidad con los puntos de cada equipo 
ggplot(goles_por_equipo, aes(x = equipo, y = goals)) +
  geom_bar(position = "dodge", stat = "summary", fill = "darkred") +
  labs(title = "Comparación goles y puntos") +
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
```
\
\
```{r}
#Porcentaje medio de posesión por equipo en casa
tapply(train$`Home_Team_Possession_%`,train$`Home_Team`,mean)
```
\
\
```{r}
#Porcentaje medio de posesión por equipo fuera de casa
tapply(train$`Away_Team_Possession_%`,train$`Away_Team`,mean)
```
\
\
```{r}
summary(Empates$`Home_Team_Possession_%`)
summary(Victorias_casa$`Home_Team_Possession_%`)
summary(Derrotas_casa$`Home_Team_Possession_%`)
#Con estos datos tan similares sacamos en conclusión que la posesión no ha influido mucho en las victorias(pobre Pep)
```
\
\
```{r}
ggplot(train,aes(Home_Team ,Home_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'red') +
  labs(title="media de goles de cada equipo como local", x="equipos", y="goles por partido") +
  theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))

# media de goles por partido de cada equipo en su casa
```
\
\
```{r}
ggplot(train,aes(Away_Team ,Away_Team_Goals_Scored)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean",
           color = 'black', fill = 'red') +
  labs(title="media de goles de cada equipo como visitante", x="equipos", y="goles por partido") +
  theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))

# Los equipos que más goles meten por partido, son los que más temporadas han estado en primera
```
\
\
```{r}
# Correlación de algunas variables
pairs(train %>%
        select(Home_Team_Goals_Scored, Home_Team_On_Target_Shots, Home_Team_Total_Shots, `Home_Team_Possession_%`, `Home_Team_Pass_Success_%`, Home_Team_Corners, Home_Team_Throw_Ins, Home_Team_Fouls, Home_Team_Aerials_Won), pch = 21, bg = "black", col = "red")
```
\
\
```{r}
hist(train$Home_Team_Goals_Scored,breaks=15, main = "Histograma de goles en casa", 
     xlab = "goles")
```
\
\
```{r}
hist(train$Away_Team_Goals_Scored,breaks=15, main = "Histograma de goles fuera", 
     xlab = "goles")
# Se marcan más goles en casa que fuera
```
\
\
```{r}
lm_fit <- lm(Home_Team_Goals_Scored~.-Home_Team, data=train)
summary(lm_fit)

#regfit_fwd <- leaps::regsubsets(Home_Team_Goals_Scored~., train, method="forward")
#for (metric in c("r2", "adjr2", "Cp", "bic")){plot(regfit_fwd, scale=metric)}
```

Variables más influyentes en los goles marcados: Centros, despejes, tarjetas rojas,\
\
\

```{r}
prop.table(table(Victorias_casa$Home_Team_Total_Shots > Victorias_casa$Away_Team_Total_Shots))
#En un 30% de las victorias de casa el equipo de casa tiró menos tiros que el de fuera
```
\
\
```{r}
prop.table(table(Victorias_casa$Home_Team_Blocked_Shots > Victorias_casa$Away_Team_Blocked_Shots))
#Los tiros bloqueados no influyen mucho en el resultado del partido
```
\
\
```{r}
prop.table(table(Derrotas_casa$Home_Team_Blocked_Shots > Derrotas_casa$Away_Team_Blocked_Shots))
#En las derrotas si vemos que el 43% de las veces bloquearon menos 
```
\
\

# REGRESION

Regrsión con todas las variables

```{r}

lm_goles <- lm(goals~., data = train)
summary(lm_goles)

```
```{r}

lm_disparos <- lm(total_shots~., data = train)
summary(lm_disparos)

```

```{r}

lm_disparos_bloqueados <- lm(total_blocked_shots~., data = train)
summary(lm_disparos_bloqueados)

```

```{r}

lm_corners <- lm(total_corners~., data = train)
summary(lm_corners)

```

```{r}

lm_centros <- lm(total_throw_ins~., data = train)
summary(lm_centros)

```

```{r}

lm_d_aereos <- lm(total_aerials_won~., data = train)
summary(lm_d_aereos)

```

```{r}

lm_despejes <- lm(total_clearances~., data = train)
summary(lm_despejes)

```

```{r}

lm_faltas <- lm(total_fouls~., data = train)
summary(lm_faltas)

```

```{r}

lm_amarillas <- lm(total_yellow_cards~., data = train)
summary(lm_amarillas)

```

```{r}

lm_rojas <- lm(total_red_cards~., data = train)
summary(lm_rojas)

```

REGRESION BACKWARD

\
\
# CONCLUSIONES
Hay muchas variables que no afectan al resultado de un partido.\
Los equipos locales ganan más.\

Hay dos equipos que sobresalen (Madrid y Barsa)\
Hay un grupo de equipos "buenos" (nunca han descendido, meten más goles...)

De cara al futuro:\
Cuanto se parecen dos partidos?\
Clusterizar equipos en buenos, medios y malos.\
Incluir las rachas de victorias, dorrotas y empates.\
Calcular los puntos que suma cada equipo por partido en función de ser local o visitante, del "nivel" del rival, etc.\
Predecir el número de goles que va a marcar cada equipo en un partido, en vez de victoria/derrota/empate.