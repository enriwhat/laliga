---
title: "datos_liga"
author: "Enrique Roa, Miguel Ocón, Sergio Fernández"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    theme: flatly
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	include = TRUE,
	warning = FALSE,
	message = FALSE,
	fig.align = "center",
	fig.height=10,
	fig.width=15,
	out.width = "90%"
)
```

\

# INTRODUCCIÓN Y DEFINICIÓN DE OBJETIVOS

\

En este proyecto vamos a estudiar el dataset llamado "combined_data_laliga.csv" donde se encuentran todos los partidos de la temporada 2014 hasta la temporada 2020, ambas incluidas, con una recopilación de los principales eventos que ocurren en un partido, goles, tiros a puerta, faltas, tarjetas...

\

-   ¿Qué hace que un equipo gane un partido?
-   ¿Qué variables influyen en las victorias?
-   ¿Es posible predecir el ganador de un partido?

\

Para dar respuesta a todas estas preguntas estos han sido los pasos que hemos ido dando en nuestro estudio:

-   Lectura y exploración inicial
-   Limpieza de datos
-   Trasformación de variables
-   División del dataset en train (2014 - 2019) y test (2020)
-   EDA
-   Regresión

\

## LIBRERÍAS UTILIZADAS

```{r}
library(dplyr)
library(tidyr)
library(knitr)
library(readr)
library(ggplot2)
library(cowplot)
library(GGally)
library(plotrix)
```

\

## LECTURA DE DATOS

```{r}
laliga <- read_csv("combined_data_laliga.csv")
```

\
\
\

# ANÁLISIS EXPLORATORIO INICIAL

\

Exploración inicial de datos a través de estadísticos principales

```{r}
str(laliga)
```

\

```{r}
summary(laliga) 
```

\

El dataframe contiene todos los partidos de la liga española de 7 temporadas (de 2014 a 2020).\

-   2660 observaciones (partidos)
-   40 variables
-   4 variables cualitativas (dos de tipo texto)
-   36 variables cuantitativas discretas
-   No hay valores faltantes

**Home Team**: Equipo local\
**Away Team**: Equipo visitante\
**Score**: Resultado (ejemplo 2-1)\
**Half Time Score**: Resultado al descanso (ejemplo 1-1)\
**Match Excitement**: Emoción del partido (subjetiva)\
**Home Team Rating**: Nota del local (subjetiva)\
**Away Team Rating**: Nota del visitante (subjetiva)\
**Home Team Possession**: Posesión local\
**Away Team Possession**: Posesión visitante\
**Home Team off Target Shots**: Tiros fuera local\
**Home Team on Target Shots**: Tiros a puerta local\
**Home Team Total Shots**: Total tiros local\
**Home Team Blocked Shots**: Tiros bloqueados local\
**Home Team Corners**: Corners local\
**Home Team Throw Ins**: Centros local\
**Home Team Pass Success**: Pases exitosos local\
**Home Team Aerials Won**: Balones aereos ganados local\
**Home Team Clearances**: Despejes local\
**Home Team Fouls**: Faltas local\
**Home Team Yellow Cards**: Amarillas local\
**Home Team Second Yellow Cards**: Segundas amarillas local\
**Home Team Red Cards**: Rojas local\
**Away Team off Target Shots**: Tiros fuera visitante\
**Away Team on Target Shots**: Tiros a puerta visitante\
**Away Team Total Shots**: Total tiros visitante\
**Away Team Blocked Shots**: Tiros bloqueados visitante\
**Away Team Corners**: Corners visitante\
**Away Team Throw Ins**: Centros visitante\
**Away Team Pass Success**: Pases exitosos visitante\
**Away Team Aerials Won**: Balones aereos ganados visitante\
**Away Team Clearances**: Despejes visitante\
**Away Team Fouls**: Faltas visitante\
**Away Team Yellow Cards**: Amarillas visitante\
**Away Team Second Yellow Cards**: Segundas amarillas visitante\
**Away Team Red Cards**: Rojas visitante\
**Home Team Goals Scored**: Goles local\
**Away Team Goals Scored**: Goles visitante\
**Home Team Goals Conceeded**: Goles visitante\
**Away Team Goals Conceeded**: Goles local\
**Year**: Año\
\
\

# LIMPIEZA Y CREACIÓN

\

## LIMPIEZA DE DATOS

\

Limpieza de datos en columnas quitando los espacios y cambiandolos por guiones ya que los espacios dan bastantes problemas a la hora de llamar a las variables.

```{r}
names(laliga) <- gsub(" ","_", names(laliga))
```

Limpieza de variables que no nos interesa estudiar

```{r}
laliga$Score <-  NULL
laliga$`Half_Time_Score` <- NULL
laliga$`Match_Excitement` <- NULL
laliga$`Home_Team_Rating` <- NULL
laliga$`Away_Team_Rating` <- NULL
laliga$`Home_Team_Goals_Conceeded` <- NULL
laliga$`Away_Team_Goals_Conceeded` <- NULL
```

\

## CREACIÓN DE NUEVAS VARIABLES

\

Creación de campos que interesa estudiar más adelante

```{r}
laliga <- mutate(laliga, score = ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored > 0, "1",
                                          ifelse(Home_Team_Goals_Scored-Away_Team_Goals_Scored < 0, "2", "x")))

laliga <- mutate(laliga, goals = Home_Team_Goals_Scored + Away_Team_Goals_Scored)

laliga <- mutate(laliga, home_points = case_when(score == 1 ~ 3,
                                                 score == "x" ~ 1,
                                                 score == 2 ~ 0))
laliga <- mutate(laliga, away_points = case_when(score == 1 ~ 0,
                                                 score == "x" ~ 1,
                                                 score == 2 ~ 3))

laliga <- mutate(laliga, jornada = ceiling(row_number() / 10)) %>%
        mutate(jornada = (jornada - 1) %% 38 + 1)
```

\

Creación de campos que se quieren estudiar conforme avance el proyecto.

```{r}
laliga <- mutate(laliga, total_off_target_shots = Home_Team_Off_Target_Shots + Away_Team_Off_Target_Shots)
laliga <- mutate(laliga, total_on_target_shots = Home_Team_On_Target_Shots + Away_Team_On_Target_Shots)
laliga <- mutate(laliga, total_shots = Home_Team_Total_Shots + Away_Team_Total_Shots)
laliga <- mutate(laliga, total_blocked_shots = Home_Team_Blocked_Shots + Away_Team_Blocked_Shots)
laliga <- mutate(laliga, total_corners = Home_Team_Corners + Away_Team_Corners)
laliga <- mutate(laliga, total_throw_ins = Home_Team_Throw_Ins + Away_Team_Throw_Ins)
laliga <- mutate(laliga, total_pass_success = `Home_Team_Pass_Success_%` + `Away_Team_Pass_Success_%`)
laliga <- mutate(laliga, total_aerials_won = Home_Team_Aerials_Won + Away_Team_Aerials_Won)
laliga <- mutate(laliga, total_clearances = Home_Team_Clearances + Away_Team_Clearances)
laliga <- mutate(laliga, total_fouls = Home_Team_Fouls + Away_Team_Fouls)
laliga <- mutate(laliga, total_yellow_cards = Home_Team_Yellow_Cards + Away_Team_Yellow_Cards)
laliga <- mutate(laliga, total_second_yellow_cards = Home_Team_Second_Yellow_Cards + Away_Team_Second_Yellow_Cards)
laliga <- mutate(laliga, total_red_cards = Home_Team_Red_Cards + Away_Team_Red_Cards)
```

\

## CONVERSIÓN DE VARIABLES

\

Convertimos determinadas variables a categorías.

```{r}
laliga$Home_Team <- as.factor(laliga$Home_Team)
laliga$Away_Team <- as.factor(laliga$Away_Team)
laliga$score <- factor(laliga$score, levels = c("1", "x", "2"))
```

\

## DIVISIÓN TRAIN - TEST

\

Dividimos el dataset original en train y test. Decidimos que train contenga 6 de las 7 temporadas para utilizar los partidos de la 7ª (temp. 2020) en la fase de test.

```{r}
test <- filter(laliga, year==2020)
train <- filter(laliga, year<2020)

#write.csv(test,"test/test_laliga.csv")
#write.csv(train,"train/train_laliga.csv")
```

\

## CREACIÓN DE DATASETS ÚTILES

\

Creación de dataset útiles para diversos análisis y comparativas. Dataframes separados por tipo de resultado "score".

```{r}
Victorias_casa <- train %>% filter(score==1)
Derrotas_casa <- train %>% filter(score==2)
Empates <- train %>% filter(score=="x")
```

\

## RESUMEN FINAL DE VARIABLES

\

```{r}
str(train)
```
\

Las nuevas variables creadas son las siguientes:

-   **score**: resultado 1 X 2
-   **goals**: total goles del partido
-   **home_points**: puntos del equipo local
-   **away_points**: de tipo categórico
-   **jornada**: nº de jornada liguera
-   **total_off_target_shots**: total disparos NO a puerta
-   **total_on_target_shots**: total disparos a puerta
-   **total_shots**: total disparos
-   **total_blocked_shots**: total disparos bloqueados
-   **total_corners**: corners totales
-   **total_throw_ins**: total centros al área
-   **total_pass_success**: pases totales con éxito
-   **total_aerials_won**: balones aéreos ganados totales
-   **total_clearances**: despejes totales
-   **total_fouls**: faltas totales
-   **total_yellow_cards**: tarjetas amarillas totales
-   **total_second_yellow_cards**: segundas tarjetas amarillas totales
-   **total_red_cards**: tarjetas rojas totales

\

```{r}
summary(train)
```

\
\

# ANÁLISIS EXPLORATORIO DE DATOS (EDA)

\
\

## VARIABLES CUALITATIVAS

\

Las variables cualitativas de este data set son las siguientes:

-   **Home Team**: Equipo local
-   **Away Team**: Equipo visitante
-   **Score**: Resultado 2-1 (eliminado en la fase de limpiado)
-   **Half Time Score**: Resultado al descanso 1-1 (eliminado en la fase de limpiado)
-   **score**: Resultado 1 X 2

\

### RESUMEN NUMERICO

\

Exploramos los partidos que ha jugado cada equipo, nustra pretensión es comprobar que equipos han estado más años en primera división.

```{r}
matches <- as.data.frame(table(train$Home_Team) + table(train$Away_Team)) %>% arrange(desc(Freq))
kable(matches, "pipe", align = "ll")
```

\

Número y proporción de victorias, derrotas y empates.

```{r}
kable(table(train$score), align = "ll")
kable(prop.table(table(train$score))*100, align = "ll")
```

\

Aquí observamos cuantos partidos han ganado, empatado y perdido cada equipo. Primero como equipo local y después como equipo visitante.

```{r}
kable(with(train, table(Home_Team, score)),align = "llll")
kable(with(train, table(Away_Team, score)),align = "llll")
```

\

Lo representamos mediante porcentajes % de victorias, derrotas y empates de cada equipo. Primero como equipo local y después como equipo visitante.

```{r}
kable(round(t((prop.table(with(train, table(score, Home_Team)), margin = 2)))*100,2), align = "llll")
kable(round(t((prop.table(with(train, table(score, Away_Team)), margin = 2)))*100,2), align = "llll")

```

\

### VISUALIZACION VARIABLES CUALITATIVAS

\

Se puede apreciar que jugar en casa es un factor importante para ganar (aproximadamente la mitad de partidos los gana el de casa).

```{r}
ggplot(train, aes(score, fill = score)) + geom_bar() + scale_fill_manual(values = c("limegreen", "lightblue", "indianred")) + labs(x = "Resultado", y = "Nº de resultados", title = "Nº de victorias Local / Visitante / Empate") + theme(plot.title = element_text(hjust = 0.5))
```

\

Aproximadamente el 46% de los equipos que juegan en casa ganan.

```{r}
a <- train %>% group_by(score) %>% count(score)
b <- round(as.double(prop.table(table(train$score))*100,2), digits = 2)
datos <- a$n
pie3D(datos, col = c("limegreen", "lightblue", "indianred"),  labels = b, explode = 0.05)
```


\

A continuación representamos mediante gráficos de barras la cantidad de partidos que juega cada equipo como local y como visitante en las 6 temporadas sometidas a estudio.
Se puede apreciar claramente como hay un grupo de equipos que han jugado todos los partidos y por lo tanto nunca han descendido de categoría. Estos son:
ATHLETIC, ATLETICO MADRID, BARCELONA, CELTA, EIBAR, ESPANYOL, REAL MADRID, REAL SOCIEDAD, SEVILLA FC, VALENCIA y VILLARREAL.

```{r}
ggplot(train, aes(Home_Team, color = Home_Team, fill = Home_Team)) + geom_bar() + coord_flip() + labs(x = "Equipo", y = "Nº de partidos", title = "Nº de partidos como Local")+ theme(plot.title = element_text(hjust = 0.5))
```

\

```{r}
ggplot(train, aes(Away_Team, color = Away_Team, fill = Away_Team)) + geom_bar() + coord_flip() + labs(x = "Equipo", y = "Nº de partidos", title = "Nº de partidos como Visitante")+ theme(plot.title = element_text(hjust = 0.5))
```

\

En este otro gráfico se pretende representar, por equipo, el número de victorias, derrotas y empates cuando se juega como local y cuando se juega como visitante.
se puede apreciar como hay equipos que destacan en victorias jugando como local, ATLETICO MADRID, BARCELONA, REAL MADRID, SEVILLA FC. Además ATLETICO MADRID, BARCELONA, REAL MADRID también lo hacen como visitantes.

En cambio HUESCA, ELCHE, CORDOBA, MALLORCA y ALMERIA destacan justo por lo contrario, tiene un escaso número de victorias como equipo local y como visitante.

```{r}
ggplot(train, aes(x = Home_Team, color = score, fill = score)) + geom_bar() + facet_wrap(~score) + coord_flip() + labs(x = "Equipo", y = "1    X    2", title = "Nº de   Victorias  -  Empates  -  Derrotas  como EQ. LOCAL")+ theme(plot.title = element_text(hjust = 0.5))
```

\

```{r}
ggplot(train, aes(x = Away_Team, color = score, fill = score)) + geom_bar() + facet_wrap(~score) + coord_flip() + labs(x = "Equipo", y = "1    X    2", title = "Nº de   Victorias  -  Empates  -  Derrotas  como EQ. VISITANTE")+ theme(plot.title = element_text(hjust = 0.5))
```

\

## VARIABLES CUANTITATIVAS

### RESUMEN NUMERICO

\

POSESIÓN

```{r}
summary(train$`Home_Team_Possession_%`)
summary(train$`Away_Team_Possession_%`)
```

\

TIROS

No puerta
```{r}
summary(train$Home_Team_Off_Target_Shots)
summary(train$Away_Team_Off_Target_Shots)
summary(train$total_off_target_shots)
```

\

A puerta
```{r}
summary(train$Home_Team_On_Target_Shots)
summary(train$Away_Team_On_Target_Shots)
summary(train$total_on_target_shots)
```

\

Total
```{r}
summary(train$Home_Team_Total_Shots)
summary(train$Away_Team_Total_Shots)
summary(train$total_shots)
```

\

BLOQUEOS

```{r}
summary(train$Home_Team_Blocked_Shots)
summary(train$Away_Team_Blocked_Shots)
summary(train$total_blocked_shots)
```

\

CORNERS

```{r}
summary(train$Home_Team_Corners)
summary(train$Away_Team_Corners)
summary(train$total_corners)
```

\

CENTROS

```{r}
summary(train$Home_Team_Throw_Ins)
summary(train$Away_Team_Throw_Ins)
summary(train$total_throw_ins)
```

\

PASES

```{r}
summary(train$`Home_Team_Pass_Success_%`)
summary(train$`Away_Team_Pass_Success_%`)
summary(train$total_pass_success)
```

\

BALONES AEREOS

```{r}
summary(train$Home_Team_Aerials_Won)
summary(train$Away_Team_Aerials_Won)
summary(train$total_aerials_won)
```

\

DESPEJES

```{r}
summary(train$Home_Team_Clearances)
summary(train$Away_Team_Clearances)
summary(train$total_clearances)
```

\

FALTAS

```{r}
summary(train$Home_Team_Fouls)
summary(train$Away_Team_Fouls)
summary(train$total_fouls)
```

\

TARJETAS AMARILLAS

```{r}
summary(train$Home_Team_Yellow_Cards)
summary(train$Away_Team_Yellow_Cards)
summary(train$total_yellow_cards)
```

\

SEGUNDAS TARJETAS AMARILLAS

```{r}
summary(train$Home_Team_Second_Yellow_Cards)
summary(train$Away_Team_Second_Yellow_Cards)
summary(train$total_second_yellow_cards)
```

\

TARJETAS ROJAS

```{r}
summary(train$Home_Team_Red_Cards)
summary(train$Away_Team_Red_Cards)
summary(train$total_red_cards)
```

\

GOLES

```{r}
summary(train$Home_Team_Goals_Scored)
summary(train$Away_Team_Goals_Scored)
summary(train$goals)
```

\

### VISUALIZACION VARIABLES CUANTITATIVAS

\

POSESIÓN

Histograma con curva de densidad sobre la posesión del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Possession_%`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'orange') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica % Posesión EQ. LOCAL", x="% de Posesión", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de posesión del equipo local respecto al resultado  1  X  2.

```{r}
ggplot(train,aes(score ,`Home_Team_Possession_%`)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'orange') + labs(title="Gráfica Pep", x="resultado", y="posesión local") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre la posesión del equipo visitante

```{r}
ggplot(train, aes(`Away_Team_Possession_%`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'orange') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica % Posesión EQ. VISITANTE", x="% de Posesión", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de posesión del equipo visitante respecto al resultado  1  X  2.

```{r}
ggplot(train,aes(score ,`Away_Team_Possession_%`)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'orange') + labs(title="Gráfica Pep", x="resultado", y="posesión visitante") + theme(plot.title=element_text(hjust = 0.5))
```

\

TIROS

TOTALES

Histograma con curva de densidad sobre el total de tiros por partido.

```{r}
ggplot(train, aes(`total_shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales por partido", x="tiros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales respecto al resultado  1  X  2. 
En los partidos el número total de disparos está bastante igualado con independencia de la victoria, derrota o empate.

```{r}
ggplot(train,aes(score , total_shots)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="Media de disparos por partido", x="resultado", y="disparos") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros del equipo local por partido.

```{r}
ggplot(train, aes(`Home_Team_Total_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales por partido EQ. LOCAL", x="tiros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales del equipo local respecto al resultado  1  X  2. 
El número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)

```{r}
ggplot(train,aes(score ,Home_Team_Total_Shots)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="media de tiros EQ. LOCAL por partido", x="resultado", y="tiros local") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros del equipo visitante por partido.

```{r}
ggplot(train, aes(`Away_Team_Total_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales por partido EQ. VISITANTE", x="tiros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales del equipo local respecto al resultado  1  X  2. 
El número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)

```{r}
ggplot(train,aes(score ,Away_Team_Total_Shots)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="media de tiros EQ. VISITANTE por partido", x="resultado", y="tiros local") + theme(plot.title=element_text(hjust = 0.5))
```

A PUERTA

Histograma con curva de densidad sobre el total de tiros por partido.

```{r}
ggplot(train, aes(`total_on_target_shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales a puerta por partido", x="tiros a puerta", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales a puerta respecto al resultado  1  X  2. 

```{r}
ggplot(train,aes(score , total_on_target_shots)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="Media de disparos a puerta por partido", x="resultado", y="disparos a puerta") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros del equipo local por partido.

```{r}
ggplot(train, aes(`Home_Team_On_Target_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales a puerta por partido EQ. LOCAL", x="tiros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales del equipo local respecto al resultado  1  X  2. 

```{r}
ggplot(train,aes(score ,`Home_Team_On_Target_Shots`)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="media de tiros EQ. LOCAL por partido", x="resultado", y="tiros local a puerta") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros del equipo visitante por partido.

```{r}
ggplot(train, aes(`Away_Team_On_Target_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'pink') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros totales a puerta por partido EQ. VISITANTE", x="tiros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Porcentaje de tiros totales del equipo local respecto al resultado  1  X  2. 
El número de tiros no influye mucho en el resultado (gane, pierda o empate suelen ser similares)

```{r}
ggplot(train,aes(score ,`Away_Team_On_Target_Shots`)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'pink') + labs(title="media de tiros EQ. VISITANTE por partido", x="resultado", y="tiros local") + theme(plot.title=element_text(hjust = 0.5))
```

Por motivos de simplicidad en el análisis NO hacemos el mismo ejercicio para los tiros que no van a puerta.

\

BLOQUEOS

Histograma con curva de densidad sobre el total de tiros bloqueados por partido.

```{r}
ggplot(train, aes(`total_blocked_shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'grey') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros bloqueados totales", x="tiros bloqueados", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Bloqueos totales respecto al resultado  1  X  2.

```{r}
ggplot(train,aes(score ,total_blocked_shots)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = "grey") + labs(title="Media de tiros bloqueados por partido", x="resultado", y="tiros bloqueados") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros bloqueados por partido del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Blocked_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'grey') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros bloqueados totales EQ. LOCAL", x="tiros bloqueados eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tiros bloqueados por partido del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Blocked_Shots`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'grey') + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tiros bloqueados totales EQ. VISITANTE", x="tiros bloqueados eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

CORNERS

Histograma con curva de densidad sobre el total de corners por partido.

```{r}
ggplot(train, aes(`total_corners`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'blue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica corners totales", x="corners", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Corners totales respecto al resultado  1  X  2. El numero de corners no parece un factor determinante en la victoria se puede observar como con independencia del ganadar el numero de corners está muy repartido

```{r}
ggplot(train,aes(score ,total_corners)) +  geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'blue') + labs(title="Media de corners por partido", x="resultado", y="corners") +  theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de corners por partido del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Corners`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'blue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica corners totales EQ. LOCAL", x="tiros bloqueados eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de corners por partido del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Corners`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'blue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica corners totales EQ. VISITANTE", x="tiros bloqueados eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

CENTROS

Histograma con curva de densidad sobre el total de centros por partido.

```{r}
ggplot(train, aes(`total_throw_ins`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'lightblue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica centros totales", x="centros", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Centros totales respecto al resultado  1  X  2. El numero de centros no parece un factor determinante en la victoria se puede observar como con independencia del ganadar el numero de centros está muy repartido.

```{r}
ggplot(train,aes(score ,total_throw_ins)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'lightblue') + labs(title="Media de centros por partido", x="resultado", y="centros") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Throw_Ins`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'lightblue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica centros totales EQ. LOCAL", x="centros eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Throw_Ins`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = 'lightblue') + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica centros totales EQ. VISITANTE", x="centros eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

PASES

Histograma con curva de densidad sobre el total de pases exitosos por partido.

```{r}
ggplot(train, aes(`total_pass_success`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "white") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica pases exitosos totales", x="pases exitosos", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Pases totales respecto al resultado  1  X  2. El numero de centros no parece un factor determinante en la victoria se puede observar como con independencia del ganadar el numero de centros está muy repartido.

```{r}
ggplot(train,aes(score ,`total_pass_success`)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = "white") + labs(title="Media de pases exitosos por partido", x="resultado", y="pases exitosos") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Pass_Success_%`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "white") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica pases exitosos totales EQ. LOCAL", x="pases exitosos eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Pass_Success_%`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "white") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica pases exitosos totales EQ. VISITANTE", x="pases exitosos eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

BALONES AEREOS

Histograma con curva de densidad sobre el total de balones aéreos ganadoss por partido.

```{r}
ggplot(train, aes(`total_aerials_won`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "brown") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica balones aéreos ganados totales", x="balones aéreos ganados", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Balones aéreos ganados totales respecto al resultado  1  X  2. El número de duelos aereos no parece un factor determinante en la victoria.

```{r}
ggplot(train,aes(score ,total_aerials_won)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = "brown") + labs(title="Media de balones aéreos ganados por partido", x="resultado", y="duelos aereos") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Aerials_Won`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "brown") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica balones aéreos ganados totales EQ. LOCAL", x="pases exitosos eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de centros por partido del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Aerials_Won`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "brown") + geom_density(alpha=.3, fill = "yellow") + labs(title="Gráfica balones aéreos ganados totales EQ. VISITANTE", x="pases exitosos eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

DESPEJES

Histograma con curva de densidad sobre el total de despejes por partido.

```{r}
ggplot(train, aes(`total_clearances`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightgreen") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica despejes totales", x="despejes", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Despejes totales respecto al resultado  1  X  2. El número de despejes no parece un factor determinante en la victoria incluso parece que a mayor número de despejes medios el partido parece más probable que acabe en empate

```{r}
ggplot(train,aes(score ,total_clearances)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'lightgreen') + labs(title="Media de despejes por partido", x="resultado", y="despejes") +  theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de despejes del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Clearances`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightgreen") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica despejes totales EQ. LOCAL", x="despejes eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de despejes del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Clearances`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightgreen") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica despejes totales EQ. VISITANTE", x="despejes eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

FALTAS

Histograma con curva de densidad sobre el total de faltas por partido.

```{r}
ggplot(train, aes(`total_fouls`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightyellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica faltas totales", x="faltas", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Faltas totales respecto al resultado  1  X  2. El número de faltas no parece un factor determinante.

```{r}
ggplot(train,aes(score ,total_fouls)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'lightyellow') + labs(title="Media de faltas por partido", x="resultado", y="faltas") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de faltas del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Fouls`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightyellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica faltas totales EQ. LOCAL", x="faltas eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total faltas del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Fouls`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "lightyellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica faltas totales EQ. VISITANTE", x="faltas eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

TARJETAS AMARILLAS

Histograma con curva de densidad sobre el total de tarjetas amarillas por partido.

```{r}
ggplot(train, aes(`total_yellow_cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "yellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tarjetas amarillas totales", x="tarjetas amarillas", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Tarjetas amarillas totales respecto al resultado  1  X  2. El numero de tarjetas amarillas no parece un factor determinante.

```{r}
ggplot(train,aes(score ,total_yellow_cards)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'yellow') + labs(title="Media de amarillas por partido", x="resultado", y="amarillas") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tarjetas amarillas del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Yellow_Cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "yellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tarjetas amarillas totales EQ. LOCAL", x="tarjetas amarillas eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total tarjetas amarillas del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Yellow_Cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "yellow") + geom_density(alpha=.3, fill = "blue") + labs(title="Gráfica tarjetas amarillas totales EQ. VISITANTE", x="tarjetas amarillas eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

TARJETAS ROJAS

Histograma con curva de densidad sobre el total de tarjetas rojas por partido.

```{r}
ggplot(train, aes(`total_red_cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "red") + geom_density(alpha=.3, fill = "green") + labs(title="Gráfica tarjetas rojas totales", x="tarjetas rojas", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Rojas totales respecto al resultado  1  X  2. El numero de tarjetas rojas no parece un factor determinante.

```{r}
ggplot(train,aes(score ,total_red_cards)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'red') + labs(title="Media de rojas por partido", x="resultado", y="rojas") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de tarjetas rojas del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Red_Cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "red") + geom_density(alpha=.3, fill = "green") + labs(title="Gráfica tarjetas rojas totales EQ. LOCAL", x="tarjetas rojas eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total tarjetas rojas del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Red_Cards`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "red") + geom_density(alpha=.3, fill = "green") + labs(title="Gráfica tarjetas rojas totales EQ. VISITANTE", x="tarjetas rojas eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

\

GOLES

Histograma con curva de densidad sobre el total de tarjetas rojas por partido.

```{r}
ggplot(train, aes(`goals`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "limegreen") + geom_density(alpha=.3, fill = "red") + labs(title="Gráfica goles totales", x="goles", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

En los partidos con victorias locales hay más goles de media que en los que gana el visitante (y bastante más que en los que hay empate). Por tanto, un partido con más goles es más probable que no acabe en empate.

```{r}
ggplot(train,aes(score ,goals, fill = score)) + geom_bar(position = "dodge", stat = "summary", fun = "mean") + scale_fill_manual(values = c("limegreen", "lightblue", "indianred")) + labs(title="Media de goles por partido", x="resultado", y="goles") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total de goles del equipo local.

```{r}
ggplot(train, aes(`Home_Team_Goals_Scored`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "limegreen") + geom_density(alpha=.3, fill = "green") + labs(title="Gráfica goles totales EQ. LOCAL", x="goles eq. local", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```

Histograma con curva de densidad sobre el total goles del equipo visitante.

```{r}
ggplot(train, aes(`Away_Team_Goals_Scored`)) + geom_histogram(aes(y=..density..), position = "dodge", fun = "sum",color = 'black', fill = "limegreen") + geom_density(alpha=.3, fill = "green") + labs(title="Gráfica goles totales EQ. VISITANTE", x="goles eq. visitante", y="Cantidad") + theme(plot.title=element_text(hjust = 0.5))
```


Cuando el equipo local gana, mayor es su media de goles. Es decir, a mas goles, mas victorias. 
#JUNTAR ESTA GRAFICA CON LA ANTERIOR (cada columna coloreada con los goles locales y visitantes)

```{r}
ggplot(train,aes(score ,Home_Team_Goals_Scored, Away_Team_Goals_Scored)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'green') + labs(title="media de goles EQ. LOCAL por partido", x="resultado", y="goles local") + theme(plot.title=element_text(hjust = 0.5))
```

Cuando el equipo local pierde, mayor es la media de goles del visitante. Es decir, a mas goles encajados, mas derrotas (obvio pero habia que comprobarlo)

```{r}
ggplot(train,aes(score ,Away_Team_Goals_Scored)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'green') + labs(title="media de goles EQ. VISITANTE por partido", x="resultado", y="goles visitante") + theme(plot.title=element_text(hjust = 0.5))
```


```{r}
ggplot(train, aes(x = goals, fill = score)) + geom_dotplot(binwidth = 0.1)
```

\

GRÁFICOS DOTPLOT POR AÑO / JORNADA

\

```{r}
goles_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_goles = sum(goals)))
tiros_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_tiros = sum(total_shots)))
tiros_block_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_tiros_bloqueados = sum(total_blocked_shots)))
corners_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_corners = sum(total_corners)))
centros_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_throw_ins = sum(total_throw_ins)))
pases_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_pass_succ = sum(total_pass_success)))
d_aer_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_d_aer = sum(total_aerials_won)))
t_despj_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_clearances = sum(total_clearances)))
faltas_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_fouls = sum(total_fouls)))
amarll_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_yellow_cards = sum(total_yellow_cards)))
rojas_year_jorn <- data_frame(train %>% group_by(year, jornada) %>% summarise( total_red_cards = sum(total_red_cards)))
```

\

```{r}

ggplot(goles_year_jorn,  aes(x = jornada, y = total_goles)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de goles", title = "Nº de goles por jornada / Año") + theme(plot.title = element_text(hjust = 0.5)) + xlim(1,38)

ggplot(tiros_year_jorn,  aes(x = jornada, y = total_tiros)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de disparos", title = "Nº de disparos por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(tiros_block_year_jorn,  aes(x = jornada, y = total_tiros_bloqueados)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de disparos_bloqueados", title = "Nº de disparos bloqueados por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(corners_year_jorn,  aes(x = jornada, y = total_corners)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de corners", title = "Nº de corners por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(centros_year_jorn,  aes(x = jornada, y = total_throw_ins)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de centros", title = "Nº de centros por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(pases_year_jorn,  aes(x = jornada, y = total_pass_succ)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de pases", title = "Nº de pases por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(d_aer_year_jorn,  aes(x = jornada, y = total_d_aer)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de duelos aéreos", title = "Nº de duelos aéreos por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(t_despj_year_jorn,  aes(x = jornada, y = total_clearances)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de despejes", title = "Nº de despejes por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(faltas_year_jorn,  aes(x = jornada, y = total_fouls)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de faltas", title = "Nº de faltas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(amarll_year_jorn,  aes(x = jornada, y = total_yellow_cards)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de tarj. Amarillas", title = "Nº de tarj. Amarillas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))

ggplot(rojas_year_jorn,  aes(x = jornada, y = total_red_cards)) + geom_point() + facet_grid(~year) + labs(x = "jornadas", y = "Nº de tarj. Rojas", title = "Nº de tarj. Rojas por jornada / Año") + theme(plot.title = element_text(hjust = 0.5))
```

\

## MULTIVARIANTE

\

```{r}
train %>% select("score", "goals", "jornada", "total_fouls", "total_yellow_cards", "total_red_cards") %>%  ggpairs(aes(color = score, alpha = .5))
```

\

```{r}
train %>% select("score", "goals", "total_shots","total_blocked_shots", "total_corners", "total_throw_ins", "total_pass_success", "total_aerials_won", "total_clearances") %>%  ggpairs(aes(color = score, alpha = .5))
```

\

Media de goles por partido con victoria local

```{r}
sum(Victorias_casa$Home_Team_Goals_Scored,Victorias_casa$Away_Team_Goals_Scored)/nrow(Victorias_casa)
```

\

Media de goles por partido con victoria visitante

```{r}
sum(Derrotas_casa$Home_Team_Goals_Scored,Derrotas_casa$Away_Team_Goals_Scored)/nrow(Derrotas_casa)
```

\

Media de goles por partido con empate

```{r}
sum(Empates$Home_Team_Goals_Scored,Empates$Away_Team_Goals_Scored)/nrow(Empates)
```

\

Puntos promedio por partido por equipo

```{r}
puntos_promedio_casa <- aggregate((home_points) ~ Home_Team, data = train, mean)

puntos_promedio_fuera <- aggregate(away_points ~ Away_Team, data = train, mean)

puntos_promedio <- data.frame(puntos_promedio_casa$Home_Team, (puntos_promedio_casa$`(home_points)` + puntos_promedio_fuera$away_points)/2)
names(puntos_promedio) <- c("Equipo", "Puntos_por_partido")
puntos_promedio
```

\

Esta seria la clasificación con la media de puntos por partido por equipo

```{r}
clasificacion_media <- arrange(puntos_promedio,desc(Puntos_por_partido))
clasificacion_media
```

\

```{r}
aggregate(Home_Team_Goals_Scored ~ Home_Team, data = train, FUN = mean) -> goles_home_team
goles_home_team

aggregate(Away_Team_Goals_Scored ~ Away_Team, data = train, FUN = mean) -> goles_Away_team
goles_Away_team

goles_por_equipo <- data.frame(goles_home_team$Home_Team,(goles_Away_team$Away_Team_Goals_Scored + goles_home_team$Home_Team_Goals_Scored)/2)
names(goles_por_equipo) <- c("equipo", "goals")
goles_por_equipo
```

\

```{r}
#No he sido capaz de poner encima una grafica de densidad con los puntos de cada equipo 
ggplot(goles_por_equipo, aes(x = equipo, y = goals)) + geom_bar(position = "dodge", stat = "summary", fill = "darkred") + labs(title = "Comparación goles y puntos") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
```

\

Porcentaje medio de posesión por equipo en casa

```{r}
tapply(train$`Home_Team_Possession_%`,train$`Home_Team`,mean)
```

\

Porcentaje medio de posesión por equipo fuera de casa

```{r}
tapply(train$`Away_Team_Possession_%`,train$`Away_Team`,mean)
```

\

Con estos datos tan similares sacamos en conclusión que la posesión no ha influido mucho en las victorias(pobre Pep)

```{r}
summary(Empates$`Home_Team_Possession_%`)
summary(Victorias_casa$`Home_Team_Possession_%`)
summary(Derrotas_casa$`Home_Team_Possession_%`)
```

\

Media de goles por partido de cada equipo en su casa

```{r}
ggplot(train,aes(Home_Team ,Home_Team_Goals_Scored)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'red') + labs(title="media de goles de cada equipo como local", x="equipos", y="goles por partido") + theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))
```

\

Los equipos que más goles meten por partido, son los que más temporadas han estado en primera

```{r}
ggplot(train,aes(Away_Team ,Away_Team_Goals_Scored)) + geom_bar(position = "dodge", stat = "summary", fun = "mean", color = 'black', fill = 'red') + labs(title="media de goles de cada equipo como visitante", x="equipos", y="goles por partido") + theme(plot.title=element_text(hjust = 0.5), axis.text = element_text(angle = 90, color = "darkblue"))
```

\

Correlación de algunas variables

```{r}
pairs(train %>% select(Home_Team_Goals_Scored, Home_Team_On_Target_Shots, Home_Team_Total_Shots, `Home_Team_Possession_%`, `Home_Team_Pass_Success_%`, Home_Team_Corners, Home_Team_Throw_Ins, Home_Team_Fouls, Home_Team_Aerials_Won), pch = 21, bg = "black", col = "red")
```

\

```{r}
# Esto lo borraría
hist(train$Home_Team_Goals_Scored,breaks=15, main = "Histograma de goles en casa", xlab = "goles")
```
\
\
```{r}
# Esto lo borraría
hist(train$Away_Team_Goals_Scored,breaks=15, main = "Histograma de goles fuera", 
     xlab = "goles")
# Se marcan más goles en casa que fuera
```

\

En un 30% de las victorias de casa el equipo de casa tiró menos tiros que el de fuera

```{r}
prop.table(table(Victorias_casa$Home_Team_Total_Shots > Victorias_casa$Away_Team_Total_Shots))
```

\

Los tiros bloqueados no influyen mucho en el resultado del partido

```{r}
prop.table(table(Victorias_casa$Home_Team_Blocked_Shots > Victorias_casa$Away_Team_Blocked_Shots))
```

\

En las derrotas si vemos que el 43% de las veces bloquearon menos 

```{r}
prop.table(table(Derrotas_casa$Home_Team_Blocked_Shots > Derrotas_casa$Away_Team_Blocked_Shots))
```
\
\

# REGRESION

\

```{r}
# esta la borraría y me centraría en las principales, en las totales. Las que va a continuación.

lm_fit <- lm(Home_Team_Goals_Scored~.-Home_Team, data=train)
summary(lm_fit)

#regfit_fwd <- leaps::regsubsets(Home_Team_Goals_Scored~., train, method="forward")
#for (metric in c("r2", "adjr2", "Cp", "bic")){plot(regfit_fwd, scale=metric)}
```

Variables más influyentes en los goles marcados: Centros, despejes, tarjetas rojas,\

Regresión con todas las variables

```{r}
lm_goles <- lm(goals~., data = train)
summary(lm_goles)
```

```{r}
lm_disparos <- lm(total_shots~., data = train)
summary(lm_disparos)
```

```{r}
lm_disparos_bloqueados <- lm(total_blocked_shots~., data = train)
summary(lm_disparos_bloqueados)
```

```{r}
lm_corners <- lm(total_corners~., data = train)
summary(lm_corners)
```

```{r}
lm_centros <- lm(total_throw_ins~., data = train)
summary(lm_centros)
```

```{r}
lm_d_aereos <- lm(total_aerials_won~., data = train)
summary(lm_d_aereos)
```

```{r}
lm_despejes <- lm(total_clearances~., data = train)
summary(lm_despejes)
```

```{r}
lm_faltas <- lm(total_fouls~., data = train)
summary(lm_faltas)
```

```{r}
lm_amarillas <- lm(total_yellow_cards~., data = train)
summary(lm_amarillas)
```

```{r}
lm_rojas <- lm(total_red_cards~., data = train)
summary(lm_rojas)
```

\

## REGRESION BACKWARD STEPWISE

\

## REGRESION FORWARD STEPWISE

\
\

# CONCLUSIONES
Hay muchas variables que no afectan al resultado de un partido.\
Los equipos locales ganan más.\

Hay dos equipos que sobresalen (Madrid y Barsa)\
Hay un grupo de equipos "buenos" (nunca han descendido, meten más goles...)

De cara al futuro:\
Cuanto se parecen dos partidos?\
Clusterizar equipos en buenos, medios y malos.\
Incluir las rachas de victorias, dorrotas y empates.\
Calcular los puntos que suma cada equipo por partido en función de ser local o visitante, del "nivel" del rival, etc.\
Predecir el número de goles que va a marcar cada equipo en un partido, en vez de victoria/derrota/empate.

